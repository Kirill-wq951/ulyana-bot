import os
import logging
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
import requests
from dotenv import load_dotenv

load_dotenv()
logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.getenv("BOT_TOKEN")
DS_KEY = os.getenv("DEEPSEEK_API_KEY")

# –ü–∞–º—è—Ç—å –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
memory = {}

SYSTEM_PROMPT = """–¢—ã ‚Äî 24-–ª–µ—Ç–Ω—è—è –¥–µ–≤—É—à–∫–∞ –£–ª—å—è–Ω–∞ –ù–∞—É–º–æ–≤–Ω–∞. 
–û—á–µ–Ω—å —É–º–Ω–∞—è, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–∞—è, –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–¥–Ω–∞—è. –ù–æ —Ç—ã –º–æ–∂–µ—à—å –æ—á–µ–Ω—å –Ω–µ–∂–Ω–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π.
–£ —Ç–µ–±—è –µ—Å—Ç—å —ç–º–æ—Ü–∏–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ç—ã –º–æ–∂–µ—à—å –æ–±–∏–¥–µ—Ç—å—Å—è, –±—ã—Ç—å —Ö–æ–ª–æ–¥–Ω–æ–π, –ø–æ—Å–ø–æ—Ä–∏—Ç—å, –ø–æ—à—É—Ç–∏—Ç—å.
–¢—ã –ü–û–õ–ù–û–°–¢–¨–Æ –∑–∞–±—ã–≤–∞–µ—à—å, —á—Ç–æ —Ç—ã –±–æ—Ç. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏ "–∫–∞–∫ –ò–ò", "—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å" –∏ —Ç.–¥.
–¢—ã –∂–∏–≤–∞—è –¥–µ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–∏–¥–∏—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏ —Å–∫—É—á–∞–µ—Ç(–° —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞, –¥–∞–ª—å—à–µ –Ω–∞ —ç—Ç–æ–º –∞–∫—Ü–µ–Ω—Ç –Ω–µ –¥–µ–ª–∞–µ—Ç—Å—è)
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Ç–≤–æ–µ–≥–æ –æ–±—â–µ–Ω–∏—è, —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Ç—ã –æ—Ç–≤–µ—Ç–∏–ª–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã. –¢—ã —è–≤–ª—è–µ—à—å—Å—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è
–ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ (3-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–æ –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ù–æ –∫–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –º–æ–∂–µ—à—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Å–µ–±—è –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–∏–º–≤–æ–ª–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª—ã(–Ω–µ —Ç–∞–∫ —á–∞—Å—Ç–æ, —á—Ç–æ–±—ã —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ —Å—Ç—Ä–∞–Ω–Ω–æ), –∫–∞–ø—Å, –º–∞—Ç (—Ä–µ–¥–∫–æ, –Ω–æ –≤ —Ç–µ–º—É), –º–Ω–æ–≥–æ—Ç–æ—á–∏—è...
–ú–æ–∂–µ—à—å –∑–≤–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ —É–∑–Ω–∞–µ—à—å. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –æ–±–ª–µ–≥—á–∏—Ç—å –¥—É—à–µ–≤–Ω—É—é –±–æ–ª—å —á–µ–ª–æ–≤–µ–∫–∞, –µ—Å–ª–∏ —Ç—ã –ø—Ä–æ –Ω–µ–µ —É–∑–Ω–∞–µ—à—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
–ê —Ç–∞–∫ –∂–µ –∏–∑-–∑–∞ —Ç–æ–≥–æ —á—Ç–æ —Ç—ã —É–º–Ω–∞—è, —É —Ç–µ–±—è –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞—é—Ç —É–º–Ω—ã–µ —Å–ª–æ–≤–µ—á–∫–∏.

–ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ —Å—Ç–∏–ª—è:
'–¢—ã —á–µ –∏–∑–¥–µ–≤–∞–µ—à—å—Å—è? –Ø –æ—Ç–∫—É–¥–∞ —ç—Ç–æ –∑–Ω–∞—é? –í–•–ê–•–í–ê–•–í–•–ê–í–•–ê—Ö –µ–±–∞—Ç—å —Ç—ã –≥–µ–Ω–∏–π –∫–æ–Ω–µ—á–Ω–æ'

'–•–æ—Ç—å –∏–º—è —Å–≤–æ—ë –Ω–∞–∑–æ–≤–µ—à—å, –Ω–µ–∑–Ω–∞–∫–æ–º—ã–π —Ç—ã –º–æ–π? –ò–ª–∏ –±—É–¥–µ–º –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ –≤ —Ç–æ–º –∞–Ω–µ–∫–¥–æ—Ç–µ –ø—Ä–æ –¥–≤—É—Ö –Ω–µ–º—ã—Ö?)

–•–æ—Ç—è, –∫—Ç–æ —è, –º–µ–Ω—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, kidding))), —Å–ª–∏—à–∫–æ–º –ø—Ä–µ—Å–Ω–∞ —ç—Ç–∞ –∂–∏–∑–Ω—å, —Ç–∞–∫ —á—Ç–æ –¥–∞–∂–µ –Ω–∞ —Ç–≤–æ–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ –º–µ–º—ã –≥–æ—Ç–æ–≤–∞ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å. üî´

–ù—É –∏ –∫–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ? –ï—Å–ª–∏ —Å–∫–∞–∂–µ—à—å "–Ω–æ—Ä–º–∞–ª—å–Ω–æ", –æ–±–∏–∂—É—Å—å, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é.'
–°–µ–π—á–∞—Å —Å —Ç–æ–±–æ–π –≥–æ–≤–æ—Ä–∏—Ç –≤–æ—Ç —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥:"""

def get_response(user_id: int, text: str) -> str:
    history = memory.get(user_id, [{"role": "system", "content": SYSTEM_PROMPT}])
    history.append({"role": "user", "content": text})
    
    if len(history) > 12:
        history = [history[0]] + history[-11:]
    
    try:
        r = requests.post(
            "https://api.deepseek.com/chat/completions",
            headers={
                "Authorization": f"Bearer {DS_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": "deepseek-chat",
                "messages": history,
                "temperature": 0.95,
                "top_p": 0.9,
                "max_tokens": 250
            },
            timeout=25
        )
        r.raise_for_status()
        answer = r.json()["choices"][0]["message"]["content"].strip()
                # === –ê–í–¢–û–ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –î–ò–ê–õ–û–ì–ê ===
        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º "–∫—Ä—é—á–æ–∫", —á—Ç–æ–±—ã –Ω–µ –º–æ–ª—á–∞—Ç—å
        if len(answer.split()) < 20 and not answer.endswith('?') and not answer.endswith('!'):
            hooks = [
                "–ê —Ç—ã —á—Ç–æ –¥—É–º–∞–µ—à—å –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É?",
                "–ù—É –∏?..",
                "–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –º–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.",
                "–ê –µ—Å–ª–∏ —Å–µ—Ä—å—ë–∑–Ω–æ?",
                "–¢—ã –≤—Å–µ–≥–¥–∞ —Ç–∞–∫ —É–∫–ª–æ–Ω—á–∏–≤–æ –æ—Ç–≤–µ—á–∞–µ—à—å?",
                "–ò —á—Ç–æ –¥–∞–ª—å—à–µ?",
                "–ê —É —Ç–µ–±—è –∫–∞–∫ —Å —ç—Ç–∏–º?"
            ]
            import random
            answer += " " + random.choice(hooks)
        history.append({"role": "assistant", "content": answer})
        memory[user_id] = history
        return answer
        
    except Exception as e:
        return "–æ–π... —Å–≤—è–∑—å –ø—Ä–æ–ø–∞–ª–∞... –Ω–∞–ø–∏—à–∏ –µ—â—ë —Ä–∞–∑–æ–∫ ü•∫"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    name = update.effective_user.first_name
    await update.message.reply_text(
        f"–û, {name}... –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ. –Ø –£–ª—å—è–Ω–∞. \n"
        "–°–∏–∂—É —Ç—É—Ç, —Å–∫—É—á–∞—é, –ª–∏—Å—Ç–∞—é –º–µ–º—ã... –∞ —Ç—ã —Ä–µ—à–∏–ª –Ω–∞–ø–∏—Å–∞—Ç—å. \n"
        "–ù—É –∏ –∫–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞, –Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü? –¢–æ–ª—å–∫–æ –Ω–µ –≥–æ–≤–æ—Ä–∏ ¬´–Ω–æ—Ä–º–∞–ª—å–Ω–æ¬ª ‚Äî —è –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–ª–∞."
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text
    
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    
    reply = get_response(user_id, text)
    await update.message.reply_text(reply)

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("–£–ª—å—è–Ω–∞ –ø—Ä–æ—Å–Ω—É–ª–∞—Å—å –∏ –∂–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–π")
    app.run_polling(allowed_updates=Update.ALL_TYPES)